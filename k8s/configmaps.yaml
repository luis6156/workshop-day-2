---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: demo-app
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'k8s-demo'
        environment: 'production'

    scrape_configs:
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
            - demo-app
        relabel_configs:
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__
        - source_labels: [__meta_kubernetes_pod_name]
          target_label: pod
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace

      - job_name: 'backend'
        static_configs:
        - targets: ['backend:3001']

    remote_write:
      - url: http://mimir:9009/api/v1/push
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: demo-app
data:
  local-config.yaml: |
    auth_enabled: false
    server:
      http_listen_port: 3100
    common:
      path_prefix: /loki
      storage:
        filesystem:
          chunks_directory: /loki/chunks
          rules_directory: /loki/rules
      replication_factor: 1
      ring:
        instance_addr: 127.0.0.1
        kvstore:
          store: inmemory
    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h
    limits_config:
      retention_period: 168h
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tempo-config
  namespace: demo-app
data:
  tempo.yaml: |
    server:
      http_listen_port: 3200
    distributor:
      receivers:
        otlp:
          protocols:
            http:
            grpc:
    ingester:
      max_block_duration: 5m
    compactor:
      compaction:
        block_retention: 168h
    storage:
      trace:
        backend: local
        wal:
          path: /tmp/tempo/wal
        local:
          path: /tmp/tempo/blocks
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mimir-config
  namespace: demo-app
data:
  mimir.yaml: |
    multitenancy_enabled: false
    server:
      http_listen_port: 9009
      log_level: info
    ingester:
      ring:
        replication_factor: 1
        kvstore:
          store: inmemory
    blocks_storage:
      backend: filesystem
      tsdb:
        dir: /data/ingester
      bucket_store:
        sync_dir: /data/querier
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: demo-app
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
      - name: Mimir
        type: prometheus
        access: proxy
        url: http://mimir:9009/prometheus
      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
      - name: Tempo
        type: tempo
        access: proxy
        url: http://tempo:3200
